<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mod List</title>
    <!-- The style.css file allows you to change the look of your web pages.
         If you include the next line in all your web pages, they will all share the same look.
         This makes it easier to make new pages for your site. -->
    <link href="style.css" rel="stylesheet" type="text/css" media="all">
    <style>
      
      th, td {
        align:center;
        display:table-cell;
        padding:10px;
        
      }
      tr{
        display:table-row;
        padding:5px;
        flex-wrap: nowrap;
      }
    
    </style>
  </head>
  <body>

    <div id='title'>All Projects:</div>
    <div style="display:inline">                 Post your ideas for things you want me to make <a href="https://1101-grills-oren.github.io/mods/ideas/">here!</a></div>
    <table id="modholder">
      
    </table>
    <script>
      loadedModData={}
      loadedVersionData={}
      function convertToDate(timestr){
        t=new Date()
        t.setFullYear(1*timestr.slice(0,4),1*timestr.slice(5,7)-1,1*timestr.slice(8,10))
        t.setHours(1*timestr.slice(11,13),1*timestr.slice(14,16),1*timestr.slice(17,19),1000*timestr.slice(19,23))
        return t
      }
      function relativeDate(datea,dateb){
        seconds=(dateb.getTime()-datea.getTime())/1000
        if(seconds<0){
        if(seconds>-60){
          return ""+(-seconds)-(-seconds)%1+" seconds ago"
        }else if(seconds>-3600){
          return ""+(-seconds/60)-(-seconds/60)%1+" minutes ago"
        }else if(seconds>-86400){
          return ""+(-seconds/60/60)-(-seconds/60/60)%1+" hours ago"
        }else if(seconds>-864000){
          return ""+(-seconds/86400)-(-seconds/86400)%1+" days ago"
        }else{
          return ["January","February","March","April","May","June","July","August","September","October","November","December"][dateb.getMonth()]+" "+dateb.getDate()+", "+dateb.getFullYear()
        }
        }else{
        if(seconds<60){
          return "in "+(seconds)-(seconds)%1+" seconds"
        }else if(seconds<3600){
          return "in "+(seconds/60)-(seconds/60)%1+" minutes"
        }else if(seconds<86400){
          return "in "+(seconds/60/60)-(seconds/60/60)%1+" hours"
        }else if(seconds<864000){
          return "in "+(seconds/86400)-(seconds/86400)%1+" days"
        }else{
          return ["January","February","March","April","May","June","July","August","September","October","November","December"][dateb.getMonth()]+" "+dateb.getDate()+", "+dateb.getFullYear()
        }
        }
      }
      function getApiJsonGeneral(link,passedinfo,datastuff={}){
        return fetch(link,datastuff).then(response =>{
          return response.blob()}).then(respb=>{
            return respb.text()}).then(respc=>{
              rvel=JSON.parse(respc);
              console.log(link,rvel,passedinfo)
              return [rvel,passedinfo];})
      }
      function getModData(modid){
        return getApiJsonGeneral("https://api.modrinth.com/v2/project/"+modid,modid)
        
      }
      
      function getUserProjects(userid){
        
        return getApiJsonGeneral("https://api.modrinth.com/v2/user/"+userid+"/projects",userid,{headers:{"Authorization":keys[userid]}})
        
      }
      function getUser(userid){
        
        return getApiJsonGeneral("https://api.modrinth.com/v2/user/"+userid,userid)
        
      }

      function getVersionData(projectVersion){
        
        return getApiJsonGeneral("https://api.modrinth.com/v2/version/"+projectVersion,projectVersion)
        
      }

      function getViews(projids,auth){
        //return getApiJsonGeneral("https://api.modrinth.com/v3/analytics/downloads?start_date=1970-01-01T00:00:00.000Z&resolution_minutes=40320000&project_ids=[\"CJpJjU7m\",\"6H8ynuG6\",\"3SikDTGm\",\"DNmbfVe1\"]")
        return getApiJsonGeneral("https://api.modrinth.com/v3/analytics/views?start_date=1970-01-01T00:00:00.000Z&resolution_minutes=40320000&project_ids="+JSON.stringify(projids),auth,{headers:{"Authorization":keys[auth]}})
      }
      
      function getUserProjectsInDepth(userid){
        a=getUserProjects(userid);
        a.then(projects=>{
        b=[]
        for(i=0;i<a.length;i++){
          b.push(a[i].id)
        }
        return (projects,b)
        })
        return a
      }
      console.log(fetch("https://raw.githubusercontent.com/1101-Grills-Oren/mods/refs/heads/main/README.md"))
      mods=[{name:'Improved Physics',types:['mod'],versions:['1.20.1'],platforms:['fabric'],link:'https://modrinth.com/mod/improved-physics'},
           {name:'Barrel Shops',types:['datapack'],versions:['1.21'],platforms:['datapack'],link:'https://modrinth.com/datapack/barrel-shops'},
           {name:'Trim Effects Mewo',types:['datapack'],versions:['1.20.1'],platforms:['datapack'],link:'https://modrinth.com/datapack/trim-effects-mewo'},
           {name:'Quality Commands',types:['mod'],versions:['1.20.1'],platforms:['fabric'],link:'https://modrinth.com/mod/quality-commands'}]
      function doesOverlap(lista,listb){
        for(i=0;i<lista.length;i++){
          for(j=0;j<listb.length;j++){
            if(lista[i]==listb[j]){
              return true;
            }
          }
        }
        return false;
      }
      versionDetails={19:4,20:6}
      function addtolist(parent,content,link,platforms,versions,views,updated,userid,downloads){
        versions=[versions[versions.length-1]]
        n=document.createElement('tr')
        dataelement=document.createElement('td')
        modnameandowner=document.createElement('div')
        modnameandowner.style.display='flex'
        modnameandowner.style.flexDirection='column'
        x=document.createElement('a')
        x.textContent=content
        x.href=link
        x.style.color="#00FF00"
        modnameandowner.append(x)
        x=document.createElement('a')
        x.className='loadUser_'+userid
        x.textContent=""
        x.href="https://modrinth.com/user/"+userid
        x.style.color="#00FF00"
        x.style.paddingLeft="10px"
        modnameandowner.append(x)
        dataelement.append(modnameandowner)
        n.append(dataelement)

        dataelement=document.createElement('td')
        dataelement.textContent=platforms.join(',')
        n.append(dataelement)

        dataelement=document.createElement('td')
        dataelement.textContent=versions.join(',')
        n.append(dataelement)

        if(views!=null){
        dataelement=document.createElement('td')
        dataelement.textContent=views
        n.append(dataelement)
        
        }else{
        dataelement=document.createElement('td')
        n.append(dataelement)
        }
        dataelement=document.createElement('td')
        dataelement.textContent=downloads
        n.append(dataelement)
        
        dataelement=document.createElement('td')
        dataelement.textContent="Last updated "+relativeDate(new Date(),convertToDate(updated))
        n.append(dataelement)
        
        /*x=document.createElement('span')
        x.textContent='          Platforms:'+platforms.join(',')+"    Versions: "+versions.join(',')+"       "+views+" Views"
        n.append(x)*/
        n.style.color='#0000FF'
        parent.append(n)
      }
      function reset(parent){
        for(i=0;parent.children.length!=0;i++){
          console.log('removing')
          parent.removeChild(parent.children[0])
        }
      }
      keys={"Gx7gGzJc":"mra_QUmBOE5w1EX0svlSGQ4bvy3koHopIpd6K8EtCX0b7kNZq64Lp2bkv8MdHYPg"}
      listOfKeys=(keyList=>{
        retval=[]
        keyList=Object.entries(keyList)
        for(i=0;i<keyList.length;i++){
          retval.push(keyList[i][0])
        }
        return retval
      })(keys)
      users=["Gx7gGzJc","7xEgkjp0","eWAPOyOl"]
      function loadonly(platforms,versions,types){
      modholder=document.querySelector("#modholder");
      reset(modholder)
      modholder.innerHTML='<thead><tr style="color: rgb(0, 0, 255);text-align:left;bold:false;"><th><div style="display: flex; flex-direction: column;"><span style="color: rgb(0, 255, 0);">Title</span><span style="color: rgb(0, 255, 0); padding-left: 10px;">Owner</span></div></th><th>Loaders</th><th>Latest Version</th><th>Views</th><th>Downloads</th><th>Last Updated</th></tr></thead>'
      for(u=0;u<users.length;u++){
      modsandids=getUserProjects(users[u])
      modsandids.then(
       modsData=>{
         userid=modsData[1]
         modsData=modsData[0]
         console.log('modsandids',userid,listOfKeys)
         ids=[]
         for(i=0;i<modsData.length;i++){
           ids.push(modsData[i].id)
         }
         console.log(ids)
         if(userid in keys){
         getViews(ids,userid).then(vauid=>{
             console.log('keyed user')
             views=vauid[0]
             tuserid=vauid[1]
             console.log('getviews',userid)
            console.log(views)
            
            for(k=0;k<modsData.length;k++){
              console.log('tryadd'+k)
              if((versions.length==0)||(doesOverlap(versions,modsData[k].versions))){
                if((platforms.length==0)||(doesOverlap(platforms,modsData[k]['']))){
                  if((types.length==0)||(doesOverlap(types,modsData[k]['']))){
                    console.log('add'+k)
                    if(views[modsData[k].id]!=undefined){
                      addtolist(modholder,modsData[k].title,"https://1101-grills-oren.github.io/mods/details/?mod="+modsData[k].id,modsData[k].loaders,modsData[k].game_versions,views[modsData[k].id][0],modsData[k].updated,tuserid,modsData[k].downloads)
                    }else{
                      addtolist(modholder,modsData[k].title,"https://1101-grills-oren.github.io/mods/details/?mod="+modsData[k].id,modsData[k].loaders,modsData[k].game_versions,"N/A",modsData[k].updated,tuserid,modsData[k].downloads)
                    }
                  }
                }
              }
            }
           getUser(tuserid).then((user)=>{
             user=user[0];
             tofill=document.getElementsByClassName('loadUser_'+user.id);
             if(user.name==null){
               user.name=user.username
             }
             for(i=0;i<tofill.length;i++){
               tofill[i].textContent="By "+user.name;
             }
           
         })
         })

         }else{
           for(k=0;k<modsData.length;k++){
              console.log('tryadd'+k)
              if((versions.length==0)||(doesOverlap(versions,modsData[k].versions))){
                if((platforms.length==0)||(doesOverlap(platforms,modsData[k]['']))){
                  if((types.length==0)||(doesOverlap(types,modsData[k]['']))){
                    console.log('add'+k)
                    addtolist(modholder,modsData[k].title,"https://1101-grills-oren.github.io/mods/details/?mod="+modsData[k].id,modsData[k].loaders,modsData[k].game_versions,null,modsData[k].updated,userid,modsData[k].downloads)
                  }
                }
              }
            }
           
         }
         getUser(userid).then(user=>{
           user=user[0]
          tofill=document.getElementsByClassName('loadUser_'+user.id)
             if(user.name==null){
               user.name=user.username
             }
             for(i=0;i<tofill.length;i++){
               tofill[i].textContent="By "+user.name;
             }
           
         })
         
       } 
      )
      }
      }
      loadonly([],[],[])
    </script>
    
  </body>
</html>
