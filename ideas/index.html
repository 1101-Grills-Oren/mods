<!DOCTYPE html>
<html>
  <head>
    <script>
      octokit=0
    </script>
    <script type="module">
      import { Octokit } from "https://esm.sh/@octokit/core";
      octokit = new Octokit({ auth: 'github_p'+'at_11BADMTJI0dmSDa8V5xAJ3_9wUUK5VYsAq'+'jNY6nndJ5rDlTVwuLIYFGGVHzvWEGAQwHFQOVRMDH7yB9C86' });
      document.onOctokitInitialized()
    </script>
    
    <title>
      Ideas
    </title>
  </head>
  <body>
    <div id="ideaslist" style="display:flex;flex-direction: column;flex-grow: 1;"></div>
    <script>
      updateContentsJsonAppendList=function(){}
      getContents=function(){}
      setContents=function(){}
    </script>
    <script>
      document.onOctokitInitialized=()=>{
        
        getContents=function(path){
        return octokit.request('GET /repos/{owner}/{repo}/contents/{path}', {
          owner: '1101-grills-oren',
          repo: 'mods',
          path: path,
          headers: {
            'X-GitHub-Api-Version': '2022-11-28'
          }
        })
      }
      setContents=function(path,contents,sha=null){
        if(sha!=null){
        return octokit.request('PUT /repos/{owner}/{repo}/contents/{path}', {
          owner: '1101-grills-oren',
          repo: 'mods',
          path: path,
          message: 'Updated By Tool',
          content: contents,
          sha:sha,
          headers: {
            'X-GitHub-Api-Version': '2022-11-28'
          }
        })
        }else{
        return octokit.request('PUT /repos/{owner}/{repo}/contents/{path}', {
          owner: '1101-grills-oren',
          repo: 'mods',
          path: path,
          message: 'Updated By Tool',
          content: contents,
          headers: {
            'X-GitHub-Api-Version': '2022-11-28'
          }
        })
        }
      }
      updateContentsJsonAppendList=function(path,value,listname){
        getContents(path).then(contents=>{
          content=JSON.parse(atob(contents.data.content))
          content[listname].push(value)
          setContents(path,btoa(JSON.stringify(content)),contents.sha)
        })
      }
      
      votes={}
      /*x=getDocCookie()
      if(x['votes']==''){
        
        onclick=function(x){
            if(x.srcElement.dataset['mode']==0){
                x.srcElement.dataset['mode']=1
                x.srcElement.textContent="a"
            }else{
                x.srcElement.dataset['mode']=0
                x.srcElement.textContent="b"
            }
        }
      }*/
      ideaslist=document.querySelector("#ideaslist");
      bannedPosts=[]
      getContents("data/bannedPosts.json").then((contentsBannedPosts)=>{getContents("data/newIdeas.json").then((contents)=>{
        newhtml=""
        contents=JSON.parse(atob(contents.data.content))
        bannedPosts=JSON.parse(atob(contentsBannedPosts.data.content))
        ideas=contents.ideas
        ideas.push([0,368364,"test",'test description'])
        ideas=ideas.sort((a,b)=>{if(a[0]<b[0]){return -1}else if(a[0]>b[0]){return 1}else{return 0}})
        for(i=0;i<contents.ideas.length;i++){
          if(ideas[i][1] in bannedPosts){
            newhtml+="<div class='clicktogglechildren' data-child=1><div style=\"color:#AAAAAA;\">"+"Post Removed by Admin"+"</div><div style='display:none; padding-left: 10px;'>"+"The contents of this post were removed. They may have been offensive, rude, or something else."+"</div></div>"
          }else{
            newhtml+="<div class='clicktogglechildren' data-child=1><div>"+contents.ideas[i][2]+"</div><div style='display:none; padding-left: 10px;'>"+contents.ideas[i][3]+"</div></div>"
          }
        }
        if(newhtml==""){
          newhtml="Sorry, nothing here at the moment."
        }
        ideaslist.innerHTML=newhtml;

        clicktoggle=document.getElementsByClassName('clicktogglechildren')
        for(i=0;i<clicktoggle.length;i++){
          
          clicktoggle[i].onclick=function(x){
              console.log(x.srcElement.parentElement)
              if(x.srcElement.parentElement.dataset['mode']==1){
                  x.srcElement.parentElement.dataset['mode']=0
                  x.srcElement.parentElement.children[x.srcElement.parentElement.dataset['child']].style.display='none'
              }else{
                  x.srcElement.parentElement.dataset['mode']=1
                  x.srcElement.parentElement.children[x.srcElement.parentElement.dataset['child']].style.display='block'
              }
          }
        }
        
      })})
      }
       //each entry is of the form [votes,id,title,description]
    </script>
    <script>
      function getDocCookie(){
        c=document.cookie.split('; ')
        d={}
        for(i=0;i<c.length;i++){
          d[c[i].split('=')[0]]=c[i].split('=').slice(1).join('=')
        }
        return d
      }
      function setDocCookie(values){
        d=Object.entries(values)
        c=[]
        for(i=0;i<c.length;i++){
          c.push(d[i].join('='))
        }
        c.join('; ')
      }
    </script>
      <span>Title</span>
      <div contenteditable="true" id="title" style="border-style: solid; border-color: rgb(153, 153, 153);">
        
      </div>
      <span>Description</span>
      <!--div style="display:flex;flex-direction:row"-->
        <div contenteditable="true" id="description" style="border-style: solid; border-color: rgb(153, 153, 153);"></div>
        <!--div id='description-preview' style="border-style: double; border-color: rgb(153, 153, 153);align-self:flex-end;"></div-->
  <!--/div-->
    <button id="createpost" onclick="createPostAndClear()"></button>
    <script>
      function createPostAndClear(){
        descr=document.querySelector("#description")
        title=document.querySelector("#title")
        if(title.textContent!=''){
          let randomInt = Math.floor(Math.random() * 4294967296);
          newPost=[0,randomInt,title.innerHTML,descr.innerHTML]
          x=getDocCookie()
          if(x.posts==null){x.posts=[]}else{
            x.posts=atob(x.posts).split(',')
          }
          bannedCount=0
          for(i=0;i<x.posts.length;i++){
            if(x.posts[i] in bannedPosts){
              bannedCount+=1;
            }
          }
          if(bannedCount>=3){
            alert("Sorry, but your ability to post ideas has been revoked due to at least three offenses.")
          }else{
            x.posts.push(randomInt)
            x.posts=btoa(x.posts.join(','))
            setDocCookie(x)
            console.log("created post with id"+randomInt)
            updateContentsJsonAppendList("data/newIdeas.json",newPost,'ideas')
          }
        }else{
          alert("Title is empty. Please input a title!")
        }
      }
      //document.querySelector("#description").oninput=function(x){x.srcElement.parentElement.children[1].innerHTML=x.srcElement.textContent}
      
      
    </script>
  </body>
</html>
